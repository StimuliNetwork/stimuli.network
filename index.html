<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stimuli Network - Helping People Reach Their Goals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        a, button { transition: all 0.2s ease-in-out; }
        section[id] { scroll-margin-top: 80px; }
        #top { scroll-margin-top: 0; }

        #hero-headline { display: block; line-height: 1.1; }
        @keyframes heroTextFadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes heroTextFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes heroTextSlideUpIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes heroTextSlideDownIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes heroTextZoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .hero-text-animate-out { animation: heroTextFadeOut 0.5s ease-in forwards; }
        .hero-text-animate-fade-in { animation: heroTextFadeIn 0.6s ease-out forwards; }
        .hero-text-animate-slide-up-in { animation: heroTextSlideUpIn 0.6s ease-out forwards; }
        .hero-text-animate-slide-down-in { animation: heroTextSlideDownIn 0.6s ease-out forwards; }
        .hero-text-animate-zoom-in { animation: heroTextZoomIn 0.6s ease-out forwards; }

        .post-content-wrapper { overflow: hidden; transition: max-height 0.5s ease-out; }
        .post-content-wrapper p { margin-bottom: 0.75rem; }
        .post-content-wrapper p:last-child { margin-bottom: 0; }
        .post-content-collapsed {
            max-height: calc((1em * 1.4 * 4.5));
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
        }
        .post-content-expanded { max-height: none; -webkit-mask-image: none; mask-image: none; }

        .post-actions {
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out, margin-top 0.3s ease-out, height 0.3s ease-out, padding-top 0.3s ease-out, border-top 0.3s ease-out;
            opacity: 1; visibility: visible; margin-top: 1rem; padding-top: 0.75rem;
            border-top: 1px solid #4b5563;
            height: auto; overflow: visible;
        }
        .post-actions.hidden {
            opacity: 0; visibility: hidden; margin-top: 0; padding-top: 0;
            border-top: none; height: 0; overflow: hidden;
        }

        .comments-container {
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out, margin-top 0.5s ease-out, padding-top 0.5s ease-out, border-top 0.5s ease-out;
            opacity: 1; visibility: visible;
            margin-top: 0; padding-top: 0; border-top: none;
            max-height: 350px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #22d3ee #1f2937;
        }
        .comments-container.comments-active {
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #374151;
        }
        .comments-container.hidden {
            height: 0; opacity: 0; visibility: hidden; margin-top: 0;
            padding-top: 0; border-top: none; overflow: hidden;
            transition: opacity 0.3s ease-out, visibility 0s linear 0.3s, height 0.4s ease-out, margin-top 0.4s ease-out, padding-top 0.4s ease-out, border-top 0.4s ease-out;
        }
          .comments-container::-webkit-scrollbar { width: 8px; }
          .comments-container::-webkit-scrollbar-track { background: #1f2937; border-radius: 4px;}
          .comments-container::-webkit-scrollbar-thumb { background-color: #22d3ee; border-radius: 4px; }
          .comments-container::-webkit-scrollbar-thumb:hover { background-color: #06b6d4; }

        .comment-count {
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
            opacity: 1; visibility: visible; min-width: 25px; text-align: center; display: inline-block;
        }
        .comment-count.invisible { opacity: 0; visibility: hidden; }
        .comment-count.loading { opacity: 0.6; }
        .comment-count[aria-busy="true"] { opacity: 0.6; }

        .comment-thread {
            margin-bottom: 0.75rem; position: relative; opacity: 0;
            transform: translateY(10px); transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .comment-thread.visible { opacity: 1; transform: translateY(0); }
          .comment { display: flex; align-items: flex-start; padding-top: 8px; }
          .comment-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
          .comment-content { flex-grow: 1; padding-top: 2px; }
          .comment-author { font-weight: 600; margin-right: 6px; }
          .comment-text { font-size: 0.875rem; line-height: 1.4; }
          .replies-wrapper { margin-left: 44px; margin-top: 0.5rem; border-left: 2px solid #374151; padding-left: 12px; }
          .reply { display: flex; align-items: flex-start; padding-top: 6px; padding-bottom: 6px; opacity: 0; transform: translateY(8px); transition: opacity 0.35s ease-out, transform 0.35s ease-out; }
          .reply.visible { opacity: 1; transform: translateY(0); }
          .reply .comment-avatar { width: 28px; height: 28px; margin-right: 10px;}
          .reply .comment-content { padding-top: 0px; }
          .reply .comment-author { font-weight: 500; font-size: 0.8rem;}
          .reply .comment-text { font-size: 0.85rem; }

        #disclaimer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 20, 0.85); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0.3s ease; }
        #disclaimer-modal.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        body.content-hidden #main-header, body.content-hidden main, body.content-hidden footer { display: none; }

        #animated-logo { display: inline-flex; align-items: center; }
        .logo-icon {
            animation: heartbeat-scale 1.5s infinite ease-in-out;
            display: inline-block;
            font-size: 1.1em;
            line-height: 1;
        }
        @keyframes heartbeat-scale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .logo-text-gradient {
            background-image: linear-gradient(to right, #06b6d4, #22d3ee, #67e8f9);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            transition: all 0.2s ease-in-out;
        }
        #animated-logo:hover .logo-text-gradient {
             background-image: linear-gradient(to right, #0891b2, #06b6d4, #22d3ee);
        }

        .gemini-button {
            background-color: #0891b2;
            color: white;
            padding: 0.3rem 0.7rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.75rem;
        }
        .gemini-button:hover {
            background-color: #0e7490;
        }
        .gemini-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .elaboration-content {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.6;
            color: #d1d5db;
        }
        .elaboration-content h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #93c5fd;
            margin-bottom: 0.5rem;
        }
        .elaboration-content p {
            margin-bottom: 0.5rem;
        }
         .elaboration-content.hidden {
            display: none;
        }
        .tts-button {
            background-color: transparent;
            color: #9ca3af;
            padding: 0.3rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s ease-in-out;
            margin-left: 0.5rem;
            border: 1px solid #4b5563;
            display: inline-flex;
            align-items: center;
            min-width: 2.25rem;
            justify-content: center;
        }
        .tts-button:hover {
            color: #06b6d4;
            border-color: #06b6d4;
        }
        .tts-button.speaking {
            color: #06b6d4;
            border-color: #06b6d4;
        }
        .tts-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .carousel-container-wrapper {
            max-width: 800px;
            margin: auto;
            position: relative;
        }
        .carousel-container {
            overflow: hidden;
            border-radius: 0.75rem;
            /* border: 1px solid #374151; Removed border */
            background-color: #1f2937;
            position: relative;
            height: 500px;
        }
        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 1.5s ease-in-out, visibility 0s linear 1.5s;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }
        .carousel-slide.active {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
            z-index: 10;
        }
        .carousel-slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.75rem;
            display: block;
        }
        .carousel-dots {
            text-align: center;
            padding: 10px 0;
            margin-top: 8px;
        }
        .carousel-dot {
            cursor: pointer;
            height: 12px;
            width: 12px;
            margin: 0 4px;
            background-color: #4b5563;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.3s ease;
        }
        .carousel-dot.active, .carousel-dot:hover {
            background-color: #22d3ee;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-normal content-hidden">
    <!-- ... Rest of your HTML body ... -->
    <div id="disclaimer-modal">
        <div class="disclaimer-modal-content bg-gray-800 p-8 rounded-xl shadow-2xl text-center max-w-md w-11/12 border border-gray-700">
            <h3 id="disclaimer-title" class="text-2xl font-semibold text-gray-100 mb-4">Disclaimer</h3>
            <p id="disclaimer-text" class="text-sm text-gray-300 mb-6 leading-relaxed">
                Stimuli.Network is a simulated preview,<br>
                AI features use generative models. Content may be inaccurate or offensive.
                <br><br>
                Proceed?
            </p>
            <div class="flex justify-center space-x-4">
                <button id="disclaimer-no-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 px-8 rounded-lg shadow-md hover:shadow-lg transition-all">No</button>
                <button id="disclaimer-yes-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-medium py-2.5 px-8 rounded-lg shadow-md hover:shadow-lg transition-all">Yes</button>
            </div>
        </div>
    </div>

    <header id="main-header" class="bg-gray-800/80 backdrop-blur-md shadow-lg sticky top-0 z-50 border-b border-gray-700">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#top" id="animated-logo" class="text-2xl font-bold nav-link group">
                <span class="logo-text-gradient">Stimuli</span>
                <i class="fas fa-brain logo-icon text-cyan-500 group-hover:text-cyan-400 transition-colors mx-1.5"></i>
                <span class="logo-text-gradient">Network</span>
            </a>
            <div class="hidden lg:flex space-x-6 items-center"> <a href="#top" class="text-gray-300 hover:text-cyan-400 font-medium nav-link">Home</a>
                <a href="#about" class="text-gray-300 hover:text-cyan-400 font-medium nav-link">About Us</a>
                <a href="#impact" class="text-gray-300 hover:text-cyan-400 font-medium nav-link">Our Vision</a>
                <a href="#projects" class="text-gray-300 hover:text-cyan-400 font-medium nav-link">Projects</a>
                <a href="#involved" class="text-gray-300 hover:text-cyan-400 font-medium nav-link">Get Involved</a>
                <a href="#community" class="text-gray-300 hover:text-cyan-400 font-medium nav-link">Community</a>
                <a href="#footer-contact" class="text-gray-300 hover:text-cyan-400 font-medium nav-link">Contact</a>
            </div>
            <div class="lg:hidden"> <button id="mobile-menu-button" class="text-gray-300 focus:outline-none hover:text-cyan-400" aria-label="Toggle mobile menu" aria-expanded="false" aria-controls="mobile-menu">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>
        <div id="mobile-menu" class="hidden lg:hidden bg-gray-800 border-t border-gray-700"> <a href="#top" class="block px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-cyan-400 font-medium nav-link">Home</a>
            <a href="#about" class="block px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-cyan-400 font-medium nav-link">About Us</a>
            <a href="#impact" class="block px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-cyan-400 font-medium nav-link">Our Vision</a>
            <a href="#projects" class="block px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-cyan-400 font-medium nav-link">Projects</a>
            <a href="#involved" class="block px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-cyan-400 font-medium nav-link">Get Involved</a>
            <a href="#community" class="block px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-cyan-400 font-medium nav-link">Community</a>
            <a href="#footer-contact" class="block px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-cyan-400 font-medium nav-link">Contact</a>
        </div>
    </header>

    <main>
        <section id="top" class="bg-gradient-to-br from-gray-800 via-gray-900 to-black text-white py-24 lg:py-40"> <div class="container mx-auto px-6 text-center">
                <h1 id="hero-headline" class="text-3xl sm:text-4xl lg:text-5xl font-bold tracking-tight mb-6 text-gray-100"> Unlock Your Potential </h1> <p id="hero-subheadline" class="text-base lg:text-lg mb-10 text-gray-300 max-w-3xl mx-auto leading-relaxed"> Stimuli Network is an initiative dedicated to helping people reach their goals. </p> <div class="mt-10">
                     <a href="#involved" class="bg-cyan-500 text-gray-900 hover:bg-cyan-400 font-semibold py-3 px-8 text-base sm:text-lg rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 ease-in-out transform hover:scale-105 nav-link">Get Involved</a>
                </div>
            </div>
        </section>

        <section id="about" class="py-20 lg:py-28 bg-gray-800 border-t border-b border-gray-700"> <div class="container mx-auto px-6 grid lg:grid-cols-2 gap-16 items-center"> <div>
                    <h2 class="text-3xl lg:text-4xl font-bold text-gray-100 mb-8">Our Story</h2> <p class="text-gray-300 text-lg mb-6 leading-relaxed">
                        Stimuli Network is an emerging initiative focused on empowering individuals to achieve their personal and professional goals. Founded by Adrian Mowrey, a passionate Computer Science student, our core belief is that everyone deserves the opportunity to reach their full potential.
                    </p>
                    <p class="text-gray-300 text-lg leading-relaxed">
                        We aim to build a supportive network offering crucial resources. The initiative is planned to be self-funded through Adrian's investments in Kaspa #KAS, eliminating the need for external donations for funding. We are, however, actively seeking partners to collaborate on our mission and benefit all who need support.
                    </p>
                </div>
                <div>
                    <img src="images/AM.png" alt="Adrian Mowrey, Founder of Stimuli Network" class="rounded-xl shadow-xl w-full max-w-md mx-auto h-auto object-cover border-2 border-gray-700" loading="lazy" onerror="this.src='https://placehold.co/600x400/374151/9ca3af?text=Founder+Photo'; this.alt='Placeholder image for founder photo'">
                    <p class="text-center text-sm text-gray-400 mt-3">Adrian Mowrey, Founder</p>
                </div>
            </div>
        </section>

        <section id="impact" class="py-20 lg:py-28 bg-gray-900"> <div class="container mx-auto px-6">
                <h2 class="text-3xl lg:text-4xl font-bold text-gray-100 mb-16 text-center">Our Vision</h2> <p id="vision-intro-text" class="text-gray-300 text-lg mb-16 max-w-2xl mx-auto text-center leading-relaxed">As we establish Stimuli Network and grow, our key goals are:</p>
                <div class="grid lg:grid-cols-3 gap-10"> <div class="bg-gray-800 p-8 rounded-xl shadow-2xl hover:shadow-cyan-500/30 transition-shadow duration-300 flex flex-col border border-gray-700 hover:border-cyan-500/50">
                        <div class="text-cyan-400 mb-6 text-5xl text-center"> <svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> </div>
                        <h3 class="text-2xl font-semibold text-gray-100 mb-3 text-center">Register as a Nonprofit</h3>
                        <p class="text-gray-300 flex-grow text-left leading-relaxed">Formalize our structure to maximize impact and transparency. The registration process and operational costs are planned to be self-funded through investments in Kaspa #KAS. Our focus is on building the network and its resources.</p>
                    </div>
                    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl hover:shadow-cyan-500/30 transition-shadow duration-300 flex flex-col border border-gray-700 hover:border-cyan-500/50">
                        <div class="text-cyan-400 mb-6 text-5xl text-center"> <svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg> </div>
                        <h3 class="text-2xl font-semibold text-gray-100 mb-3 text-center">Offer Internships</h3>
                        <p class="text-gray-300 flex-grow text-left leading-relaxed">Provide valuable work experience to students by connecting them with partners serving communities across the United States.</p>
                    </div>
                    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl hover:shadow-cyan-500/30 transition-shadow duration-300 flex flex-col border border-gray-700 hover:border-cyan-500/50">
                        <div class="text-cyan-400 mb-6 text-5xl text-center"> <svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" /></svg> </div>
                        <h3 class="text-2xl font-semibold text-gray-100 mb-3 text-center">Build Scholarship Fund</h3>
                        <p class="text-gray-300 flex-grow text-left leading-relaxed">Create a dedicated fund to support students who face financial barriers in completing their studies. This will be a key focus once the network is established and generating its own sustainable resources beyond the initial self-funding.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="projects" class="py-20 lg:py-28 bg-gray-800 border-t border-b border-gray-700"> <div class="container mx-auto px-6">
                <h2 class="text-3xl lg:text-4xl font-bold text-gray-100 mb-16 text-center">Our Projects</h2> <div class="carousel-container-wrapper">
                    <div class="carousel-container">
                        </div>
                    <div class="carousel-dots">
                        </div>
                </div>
                </div>
        </section>
        <section id="involved" class="py-20 lg:py-28 bg-gray-900"> <div class="container mx-auto px-6">
                <h2 class="text-3xl lg:text-4xl font-bold text-gray-100 mb-8 text-center">Get Involved</h2> <p id="involved-intro-text" class="text-gray-300 text-lg mb-16 max-w-2xl mx-auto text-center leading-relaxed">
                    There are many ways to contribute. Your time and skills are invaluable as we launch this initiative.
                </p>
                <div class="grid lg:grid-cols-2 gap-10 max-w-4xl mx-auto"> <div class="bg-gray-700/70 border border-gray-600 rounded-xl p-10 text-left shadow-xl hover:shadow-cyan-500/20 transition-shadow duration-300 hover:border-cyan-500/40">
                        <h3 class="text-2xl font-semibold text-gray-100 mb-4">Volunteer</h3>
                        <p class="text-gray-300 mb-8 leading-relaxed">Lend your time and skills. As we grow, we'll need passionate individuals to help us achieve our mission.</p>
                        <a href="#footer-contact" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 nav-link inline-block">Express Interest</a>
                    </div>
                    <div class="bg-gray-700/70 border border-gray-600 rounded-xl p-10 text-left shadow-xl hover:shadow-cyan-500/20 transition-shadow duration-300 hover:border-cyan-500/40">
                        <h3 class="text-2xl font-semibold text-gray-100 mb-4">Partner With Us</h3>
                        <p class="text-gray-300 mb-8 leading-relaxed">Collaborate with Stimuli Network to amplify our impact. We're looking for organizations and individuals who share our vision.</p>
                        <a href="#footer-contact" class="bg-transparent text-cyan-400 border-2 border-cyan-500 hover:bg-cyan-500 hover:text-gray-900 font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 nav-link inline-block">Become a Partner</a>
                    </div>
                </div>
            </div>
        </section>

        <section id="community" class="py-20 lg:py-28 bg-gray-800 border-t border-gray-700"> <div class="container mx-auto px-6">
                <h2 class="text-3xl lg:text-4xl font-bold text-gray-100 mb-16 text-center">Community Updates</h2> <div id="community-posts-container" class="max-w-2xl mx-auto">
                    <p id="posts-loading-message" class="text-center text-gray-400 italic">Generating initial community update ✨...</p>
                     </div>
            </div>
        </section>

    </main>

    <footer id="footer-contact" class="bg-black text-gray-300 py-16 border-t border-gray-700">
        <div class="container mx-auto px-6 text-center">
            <div class="mb-10">
                <h4 class="text-2xl font-semibold text-white mb-3">Get in Touch</h4>
                <p class="text-base text-gray-400 mb-4 max-w-md mx-auto leading-relaxed">Have questions or want to partner or volunteer?<br>We'd love to hear from you.</p>
                <p class="text-lg mb-2">
                    <a href="mailto:Contact@Stimuli.Network" class="text-cyan-400 hover:text-cyan-300 hover:underline">Contact@Stimuli.Network</a>
                </p>
            </div>
            <div class="border-t border-gray-700 pt-10 text-center text-sm text-gray-400">
                <p> <span id="current-year"></span> Stimuli Network. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        const stimuliApp = {
            config: {
                API_BASE_URL: 'https://stimuli-network-ybgi.onrender.com',
                MIN_DISPLAY_DELAY_MS: 15000,
                MAX_DISPLAY_DELAY_MS: 30000,
                REPLY_PROBABILITY: 0.3,
                AI_REPLY_GENERATION_ENABLED: true,
                AI_REPLY_FALLBACK_TO_DUMMY: true,
                AUTHOR_NAMES: ["Alex", "Jamie", "Morgan", "Taylor", "Casey", "Jordan", "Riley", "Skyler", "Ash", "Kai", "Devon", "Rowan", "Max", "Eli", "Finn", "Dakota", "Avery", "Remi", "Charlie", "Blake", "Drew", "Hayden", "Jesse", "Quinn", "Lee", "Sage", "Cameron", "Micah", "Noel", "Phoenix"],
                DUMMY_REPLIES: [
                    "Good point!", "Interesting thought.", "I agree.", "Makes sense.", "Thanks for sharing.",
                    "Helpful perspective.", "Couldn't have said it better.", "Exactly!", "Totally.", "Right on.",
                    "Well said.", "That resonates.", "True.", "Indeed.", "For sure.", "Got it.", "Understood.",
                    "Nice addition.", "Valuable input.", "Great insight.", "I see what you mean.", "That's clear.",
                    "Appreciate the clarification.", "Thanks!", "Cool.", "Okay.", "Fair enough.", "Word.", "Yep.",
                    "Absolutely.", "Spot on.", "Love this.", "Great comment."
                ],
                COLLAPSED_LINES: 4.5,
                ANIMATION_INTERVAL_HERO_MIN_MS: 10000,
                ANIMATION_INTERVAL_HERO_MAX_MS: 20000,
                PROJECT_IMAGES: [
                    { src: "images/projects/Stimuli Spot Trader - Start.png", alt: "Stimuli Spot Trader - Start" },
                    { src: "images/projects/Stimuli Spot Trader - Dashboard.png", alt: "Stimuli Spot Trader - Dashboard" },
                    { src: "images/projects/BTCUSDT.png", alt: "BTCUSDT" },
                    { src: "images/projects/XXBTZUSD.png", alt: "XXBTZUSD" },
                    { src: "images/projects/BTCUSD.png", alt: "BTCUSD" },
                    { src: "images/projects/$niper.png", alt: "$niper Indicator" },
                    { src: "images/projects/IAP.png", alt: "IAP Indicator" }
                ]
            },
            state: {
                loadingCommentCount: {},
                postCommentCounts: {},
                activeSimulations: {},
                heroSubheadlinesList: [
                    "Discover your strengths and share them with a supportive community.",
                    "Unlock new possibilities with resources for personal and professional development.",
                    "Celebrating every step forward: Member achievements and shared growth.",
                    "Connect with inspiring ideas and fuel your journey to success.",
                    "Collaborate on meaningful projects that make a real difference.",
                    "Find purpose and impact by lending your unique skills and talents.",
                    "Explore innovative solutions and contribute to positive change.",
                    "Nurture your ambitions and well-being on your path to fulfillment.",
                    "Ignite your creativity and brainstorm transformative ideas with peers.",
                    "Navigate challenges with the strength of a supportive network.",
                    "Build authentic connections that foster growth and open doors.",
                    "Accelerate your journey with pathways to new opportunities.",
                    "Expand your horizons through continuous learning and shared knowledge.",
                    "Find guidance and inspiration through meaningful connections.",
                    "Make a tangible impact through community-focused initiatives.",
                    "Develop your leadership potential and inspire others along the way.",
                    "Empower yourself with new skills for a rapidly evolving world.",
                    "Join a circle of innovators and entrepreneurs driving change.",
                    "Showcase your unique talents and inspire the Stimuli Network community.",
                    "Gain broader perspectives through collaboration and diverse insights.",
                    "Prepare for the future by embracing new skills and emerging trends.",
                    "Enhance your effectiveness with proven strategies for success.",
                    "Achieve your personal and professional goals with community support.",
                    "Master the art of communication and amplify your voice.",
                    "Craft a compelling narrative that reflects your unique potential.",
                    "Leverage collective wisdom to make informed, impactful decisions.",
                    "Contribute to a sustainable future through conscious action and innovation.",
                    "Gain valuable skills to navigate and succeed in all aspects of life.",
                    "Explore the vital link between well-being and peak performance.",
                    "Experience the power of collaboration in achieving shared success."
                ],
                usedSubheadlineIndexes: [],
                postGenerationTriggered: false,
                postViewData: {},
                speechSynthesis: window.speechSynthesis,
                currentUtterance: null,
                speakingElementId: null,
                currentCarouselSlide: 0,
                carouselIntervalId: null
            },

            async fetchFromServer(endpoint, body) {
                try {
                    const response = await fetch(`${this.config.API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: `Server error: ${response.status}` }));
                        return { error: errorData.error || `Server error: ${response.status}` };
                    }
                    return await response.json();
                } catch (error) {
                    return { error: `Network error or server unavailable: ${error.message}` };
                }
            },

            splitTextIntoTwoLines(text) {
                const words = text.split(' ');
                if (words.length <= 6) return text;
                const totalLength = text.length;
                let bestSplitPoint = -1;
                let minDifference = Infinity;

                for (let i = 0; i < words.length - 1; i++) {
                    const line1 = words.slice(0, i + 1).join(' ');
                    const line2 = words.slice(i + 1).join(' ');
                    const line1Length = line1.length;
                    const line2Length = line2.length;

                    if (line1Length < totalLength * 0.25 || line2Length < totalLength * 0.25 || words.slice(0,i+1).length < 3 || words.slice(i+1).length < 3) {
                        continue;
                    }
                    const difference = Math.abs(line1Length - line2Length);
                    if (difference < minDifference) {
                        minDifference = difference;
                        bestSplitPoint = i;
                    }
                }
                if (bestSplitPoint !== -1) {
                    const line1 = words.slice(0, bestSplitPoint + 1).join(' ');
                    const line2 = words.slice(bestSplitPoint + 1).join(' ');
                    return `${line1}<br>${line2}`;
                }
                if (words.length > 6) {
                    const midPoint = Math.ceil(words.length / 2);
                    const line1 = words.slice(0, midPoint).join(' ');
                    const line2 = words.slice(midPoint).join(' ');
                    return `${line1}<br>${line2}`;
                }
                return text;
            },

            resetPostState(postId, fullReset = true) {
                const simulation = this.state.activeSimulations[postId];
                if (simulation && simulation.timeoutId) { clearTimeout(simulation.timeoutId); }

                const mainTtsButtonId = `tts-button-${postId}`;
                const elaborationTtsButtonId = `tts-elaboration-button-${postId}`;

                if (this.state.speechSynthesis?.speaking &&
                    (this.state.speakingElementId === mainTtsButtonId || this.state.speakingElementId === elaborationTtsButtonId)) {
                    if (this.state.currentUtterance) {
                        this.state.currentUtterance.onend = null;
                        this.state.currentUtterance.onerror = null;
                    }
                    this.state.speechSynthesis.cancel();
                    this.state.currentUtterance = null;
                    this.state.speakingElementId = null;
                }

                if (fullReset) {
                    delete this.state.activeSimulations[postId];
                    delete this.state.loadingCommentCount[postId];
                    delete this.state.postCommentCounts[postId];
                    this.clearPostViewInterval(postId);
                } else {
                     if(this.state.activeSimulations[postId]) {
                         this.state.activeSimulations[postId].commentsData = [];
                         this.state.activeSimulations[postId].displayedCommentCount = 0;
                         this.state.activeSimulations[postId].totalFetchedCount = 0;
                     }
                     delete this.state.postCommentCounts[postId];
                }

                const postElement = document.querySelector(`.community-post[data-post-id="${postId}"]`);
                if (!postElement) return;

                const commentsContainer = postElement.querySelector(`#comments-container-${postId}`);
                const commentCountElement = postElement.querySelector(`#comment-count-${postId}`);
                const postActionsDiv = postElement.querySelector(`#post-actions-${postId}`);
                const commentIconBtn = postElement.querySelector(`.comment-btn[data-post-id="${postId}"]`);
                const mainTtsBtn = postElement.querySelector(`#tts-button-${postId}`);
                const elaborationTtsBtn = postElement.querySelector(`#tts-elaboration-button-${postId}`);

                if (commentCountElement) {
                    commentCountElement.textContent = '0 / 0';
                    commentCountElement.classList.add('invisible');
                    commentCountElement.classList.remove('loading');
                    commentCountElement.setAttribute('aria-busy', 'false');
                }
                if (commentsContainer) {
                    commentsContainer.innerHTML = '';
                    commentsContainer.classList.add('hidden');
                    commentsContainer.classList.remove('comments-active');
                }
                if (commentIconBtn) { commentIconBtn.setAttribute('aria-expanded', 'false'); }

                if (mainTtsBtn) {
                    mainTtsBtn.classList.remove('speaking');
                    mainTtsBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    mainTtsBtn.setAttribute('aria-label', 'Read post aloud');
                }
                 if (elaborationTtsBtn) {
                    elaborationTtsBtn.classList.remove('speaking');
                    elaborationTtsBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    elaborationTtsBtn.setAttribute('aria-label', 'Read elaboration aloud');
                }

                if (fullReset) {
                    const showMoreBtn = postElement.querySelector(`#show-more-${postId}`);
                    if (postActionsDiv && showMoreBtn && !showMoreBtn.classList.contains('hidden')) {
                        postActionsDiv.classList.add('hidden');
                    }
                     const elaborationContentDiv = postElement.querySelector(`#elaboration-content-${postId}`);
                    if (elaborationContentDiv) {
                        elaborationContentDiv.innerHTML = '';
                        elaborationContentDiv.classList.add('hidden');
                        const elaborateBtn = postElement.querySelector(`#elaborate-post-${postId}`);
                        if (elaborateBtn) elaborateBtn.textContent = 'Elaborate with AI ✨';
                    }
                }
            },

            resetOtherPosts(currentPostId) {
                document.querySelectorAll('.community-post').forEach(post => {
                    const postId = post.getAttribute('data-post-id');
                    if (postId && postId !== currentPostId) {
                        const otherShowLessBtn = post.querySelector(`#show-less-${postId}`);
                        const isExpanded = otherShowLessBtn && !otherShowLessBtn.classList.contains('hidden');

                        this.resetPostState(postId, true);

                        if (isExpanded) {
                            const contentWrapper = post.querySelector(`#post-content-${postId}`);
                            const showMoreBtn = post.querySelector(`#show-more-${postId}`);
                            const postActionsDiv = post.querySelector(`#post-actions-${postId}`);
                            const commentIconBtn = post.querySelector(`.comment-btn[data-post-id="${postId}"]`);

                            if (contentWrapper && showMoreBtn && otherShowLessBtn && postActionsDiv) {
                                const computedStyle = window.getComputedStyle(contentWrapper);
                                const lineHeight = parseFloat(computedStyle.lineHeight);
                                const fontSize = parseFloat(computedStyle.fontSize);
                                const effectiveLineHeight = isNaN(lineHeight) ? fontSize * 1.4 : lineHeight;
                                const collapsedHeightThreshold = effectiveLineHeight * this.config.COLLAPSED_LINES;

                                contentWrapper.style.maxHeight = `${Math.round(collapsedHeightThreshold)}px`;
                                setTimeout(() => { contentWrapper.classList.add('post-content-collapsed'); }, 10);
                                contentWrapper.classList.remove('post-content-expanded');
                                otherShowLessBtn.classList.add('hidden');
                                showMoreBtn.classList.remove('hidden');
                                postActionsDiv.classList.add('hidden');
                                showMoreBtn.setAttribute('aria-expanded', 'false');
                                otherShowLessBtn.setAttribute('aria-expanded', 'false');
                                if(commentIconBtn) commentIconBtn.setAttribute('aria-expanded', 'false');
                            }
                        }
                    }
                });
            },

            createCommentElementHTML(postId, commentIndex, author, avatarInitial, text) {
                const threadDiv = document.createElement('div');
                threadDiv.className = 'comment-thread';
                threadDiv.setAttribute('data-comment-thread-id', `${postId}-${commentIndex}`);
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                const avatarImg = document.createElement('img');
                avatarImg.className = 'comment-avatar';
                avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(avatarInitial)}&background=111827&color=06b6d4&size=32&font-size=0.5&bold=true`;
                avatarImg.alt = `${author} avatar`;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'comment-content';
                const authorSpan = document.createElement('span');
                authorSpan.className = 'comment-author text-gray-200';
                authorSpan.textContent = author;
                const textP = document.createElement('p');
                textP.className = 'comment-text text-gray-400';
                textP.textContent = text;
                contentDiv.appendChild(authorSpan);
                contentDiv.appendChild(textP);
                commentDiv.appendChild(avatarImg);
                commentDiv.appendChild(contentDiv);
                const repliesWrapperDiv = document.createElement('div');
                repliesWrapperDiv.className = 'replies-wrapper';
                threadDiv.appendChild(commentDiv);
                threadDiv.appendChild(repliesWrapperDiv);
                return threadDiv;
            },

            createReplyElementHTML(author, avatarInitial, text) {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'reply';
                const avatarImg = document.createElement('img');
                avatarImg.className = 'comment-avatar';
                avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(avatarInitial)}&background=1f2937&color=22d3ee&size=28&font-size=0.5&bold=true`;
                avatarImg.alt = `${author} avatar`;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'comment-content';
                const authorSpan = document.createElement('span');
                authorSpan.className = 'comment-author text-gray-200';
                authorSpan.textContent = author;
                const textP = document.createElement('p');
                textP.className = 'comment-text text-gray-400';
                textP.textContent = text;
                contentDiv.appendChild(authorSpan);
                contentDiv.appendChild(textP);
                replyDiv.appendChild(avatarImg);
                replyDiv.appendChild(contentDiv);
                return replyDiv;
            },

            async loadAndPrepareComments(postId) {
                if (this.state.loadingCommentCount[postId]) return;
                this.state.loadingCommentCount[postId] = true;
                if (!this.state.activeSimulations[postId]) {
                    this.state.activeSimulations[postId] = { commentsData: [], displayedCommentCount: 0, timeoutId: null, totalFetchedCount: 0 };
                } else {
                    this.state.activeSimulations[postId].commentsData = [];
                    this.state.activeSimulations[postId].displayedCommentCount = 0;
                    this.state.activeSimulations[postId].totalFetchedCount = 0;
                    if (this.state.activeSimulations[postId].timeoutId) {
                        clearTimeout(this.state.activeSimulations[postId].timeoutId);
                        this.state.activeSimulations[postId].timeoutId = null;
                    }
                }
                this.resetOtherPosts(postId);
                const postElement = document.querySelector(`.community-post[data-post-id="${postId}"]`);
                if (!postElement) { this.resetPostState(postId, true); return; }
                const commentsContainer = postElement.querySelector(`#comments-container-${postId}`);
                const commentCountElement = postElement.querySelector(`#comment-count-${postId}`);
                const postActionsDiv = postElement.querySelector(`#post-actions-${postId}`);
                const postContentElement = postElement.querySelector(`#post-content-${postId}`);
                if (!commentsContainer || !commentCountElement || !postActionsDiv || !postContentElement) {
                    this.resetPostState(postId, true);
                    return;
                }
                postActionsDiv.classList.remove('hidden');
                this.startPostViewIntervalIfNeeded(postId);
                commentCountElement.textContent = '...';
                commentCountElement.classList.remove('invisible');
                commentCountElement.classList.add('loading');
                commentCountElement.setAttribute('aria-busy', 'true');
                commentsContainer.innerHTML = '';
                commentsContainer.classList.add('hidden');
                commentsContainer.classList.remove('comments-active');

                const postTextForContext = postContentElement.textContent.substring(0, 800);
                const serverResponse = await this.fetchFromServer('/api/generate-comment', { context: postTextForContext });

                let commentsArray = [];
                if (serverResponse && !serverResponse.error && Array.isArray(serverResponse.comments)) {
                    commentsArray = serverResponse.comments.filter(c => typeof c === 'string' && c.trim() !== '');
                } else {
                     commentsArray = ["Thanks for sharing this update! (Server fallback)"];
                }

                const totalFetchedCount = commentsArray.length;
                this.state.postCommentCounts[postId] = totalFetchedCount;

                if (this.state.activeSimulations[postId]) {
                    this.state.activeSimulations[postId].commentsData = commentsArray;
                    this.state.activeSimulations[postId].totalFetchedCount = totalFetchedCount;
                } else {
                    delete this.state.loadingCommentCount[postId];
                    return;
                }
                const finalCommentCountElement = postElement.querySelector(`#comment-count-${postId}`);
                if (finalCommentCountElement) {
                    const finalPostActionsDiv = postElement.querySelector(`#post-actions-${postId}`);
                    finalCommentCountElement.setAttribute('aria-busy', 'false');
                    if (finalPostActionsDiv && !finalPostActionsDiv.classList.contains('hidden')) {
                        finalCommentCountElement.textContent = `0 / ${totalFetchedCount}`;
                        finalCommentCountElement.classList.remove('loading');
                        if (totalFetchedCount === 0) {
                            finalCommentCountElement.classList.add('invisible');
                            finalCommentCountElement.textContent = '0 / 0';
                        } else {
                            finalCommentCountElement.classList.remove('invisible');
                        }
                    } else {
                        finalCommentCountElement.textContent = '0 / 0';
                        finalCommentCountElement.classList.add('invisible');
                        finalCommentCountElement.classList.remove('loading');
                    }
                }
                if (totalFetchedCount > 0) {
                    this.startCommentDisplay(postId);
                }
                delete this.state.loadingCommentCount[postId];
            },

            startCommentDisplay(postId) {
                const simulation = this.state.activeSimulations[postId];
                if (!simulation || simulation.timeoutId) return;
                if (!simulation.commentsData || simulation.commentsData.length === 0) return;
                const commentsContainer = document.getElementById(`comments-container-${postId}`);
                if (!commentsContainer) { this.resetPostState(postId, true); return; }
                simulation.displayedCommentCount = 0;
                commentsContainer.innerHTML = '';
                commentsContainer.classList.remove('hidden');
                commentsContainer.classList.add('comments-active');
                this.scheduleNextDisplay(postId, true);
            },

            scheduleNextDisplay(postId, isFirstCall = false) {
                const simulation = this.state.activeSimulations[postId];
                if (!simulation) return;
                if (simulation.timeoutId) { clearTimeout(simulation.timeoutId); simulation.timeoutId = null; }
                if (simulation.displayedCommentCount >= simulation.totalFetchedCount && !isFirstCall && !this.config.AI_REPLY_GENERATION_ENABLED) return;
                if (simulation.displayedCommentCount >= simulation.totalFetchedCount && !isFirstCall && this.config.AI_REPLY_GENERATION_ENABLED && Math.random() > this.config.REPLY_PROBABILITY * 2) return;

                const delay = isFirstCall ? 100 : Math.random() * (this.config.MAX_DISPLAY_DELAY_MS - this.config.MIN_DISPLAY_DELAY_MS) + this.config.MIN_DISPLAY_DELAY_MS;
                simulation.timeoutId = setTimeout(() => {
                    if (!this.state.activeSimulations[postId]) return;
                    this.displayNextItem(postId);
                    if (this.state.activeSimulations[postId]) {
                         this.scheduleNextDisplay(postId);
                    }
                }, delay);
            },

            async displayNextItem(postId) {
                const simulation = this.state.activeSimulations[postId];
                if (!simulation) return;
                const commentsContainer = document.getElementById(`comments-container-${postId}`);
                const commentCountElement = document.getElementById(`comment-count-${postId}`);
                if (!commentsContainer || !document.body.contains(commentsContainer) || !commentCountElement) {
                    this.resetPostState(postId, true);
                    return;
                }
                const totalFetchedCount = simulation.totalFetchedCount;
                const canAddReply = simulation.displayedCommentCount > 0;
                let shouldAttemptAnyReply = canAddReply && Math.random() < this.config.REPLY_PROBABILITY;

                if (simulation.displayedCommentCount >= totalFetchedCount && this.config.AI_REPLY_GENERATION_ENABLED) {
                    shouldAttemptAnyReply = true;
                }

                const shouldAddComment = simulation.displayedCommentCount < totalFetchedCount &&
                                         (!shouldAttemptAnyReply || Math.random() < 0.6);

                if (shouldAddComment) {
                    const commentIndex = simulation.displayedCommentCount;
                    const commentText = simulation.commentsData[commentIndex];
                    const author = this.config.AUTHOR_NAMES[Math.floor(Math.random() * this.config.AUTHOR_NAMES.length)];
                    const avatarInitial = author.charAt(0).toUpperCase();
                    const newCommentThreadElement = this.createCommentElementHTML(postId, commentIndex, author, avatarInitial, commentText);
                    commentsContainer.appendChild(newCommentThreadElement);
                    requestAnimationFrame(() => {
                        setTimeout(() => { if (document.body.contains(newCommentThreadElement)) newCommentThreadElement.classList.add('visible'); }, 50);
                    });
                    simulation.displayedCommentCount++;
                    commentCountElement.textContent = `${simulation.displayedCommentCount} / ${totalFetchedCount}`;
                } else if (shouldAttemptAnyReply) {
                    const visibleThreads = commentsContainer.querySelectorAll('.comment-thread.visible');
                    if (visibleThreads.length > 0) {
                        const targetThread = visibleThreads[Math.floor(Math.random() * visibleThreads.length)];
                        const repliesWrapper = targetThread.querySelector('.replies-wrapper');
                        const parentCommentTextElement = targetThread.querySelector('.comment .comment-text');

                        if (repliesWrapper && parentCommentTextElement) {
                            const parentCommentText = parentCommentTextElement.textContent;
                            let replyText = this.config.DUMMY_REPLIES[Math.floor(Math.random() * this.config.DUMMY_REPLIES.length)];

                            if (this.config.AI_REPLY_GENERATION_ENABLED && parentCommentText.trim() !== "") {
                                try {
                                    const serverResponse = await this.fetchFromServer('/api/generate-reply', { parentCommentText });
                                    if (serverResponse && serverResponse.replyText && serverResponse.replyText.trim() !== "") {
                                        replyText = serverResponse.replyText;
                                    } else {
                                        if (!this.config.AI_REPLY_FALLBACK_TO_DUMMY) {
                                            if (commentsContainer.scrollHeight - commentsContainer.scrollTop - commentsContainer.clientHeight < 100) {
                                                commentsContainer.scrollTo({ top: commentsContainer.scrollHeight, behavior: 'smooth' });
                                            }
                                            return;
                                        }
                                    }
                                } catch (error) {
                                    if (!this.config.AI_REPLY_FALLBACK_TO_DUMMY) {
                                         if (commentsContainer.scrollHeight - commentsContainer.scrollTop - commentsContainer.clientHeight < 100) {
                                            commentsContainer.scrollTo({ top: commentsContainer.scrollHeight, behavior: 'smooth' });
                                        }
                                        return;
                                    }
                                }
                            }

                            const replyAuthor = this.config.AUTHOR_NAMES[Math.floor(Math.random() * this.config.AUTHOR_NAMES.length)];
                            const replyAvatarInitial = replyAuthor.charAt(0).toUpperCase();
                            const newReplyElement = this.createReplyElementHTML(replyAuthor, replyAvatarInitial, replyText);
                            repliesWrapper.appendChild(newReplyElement);
                            requestAnimationFrame(() => {
                                setTimeout(() => { if(document.body.contains(newReplyElement)) newReplyElement.classList.add('visible'); }, 50);
                            });
                        }
                    }
                }
                if (commentsContainer.scrollHeight - commentsContainer.scrollTop - commentsContainer.clientHeight < 100) {
                    commentsContainer.scrollTo({ top: commentsContainer.scrollHeight, behavior: 'smooth' });
                }
            },

            initializeMenuAndScroll() {
                const menuButton = document.getElementById('mobile-menu-button');
                const mobileMenu = document.getElementById('mobile-menu');
                const header = document.getElementById('main-header');
                if(menuButton && mobileMenu) {
                    menuButton.addEventListener('click', () => {
                        const isHidden = mobileMenu.classList.toggle('hidden');
                        menuButton.setAttribute('aria-expanded', String(!isHidden));
                    });
                }
                const navLinks = document.querySelectorAll('a.nav-link[href^="#"]');
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (document.body.classList.contains('content-hidden')) return;
                        let targetId = link.getAttribute('href');
                        let targetElement = null;
                        try {
                            if (targetId && targetId !== '#') {
                                targetElement = document.querySelector(targetId);
                            }
                        } catch (error) { return; }
                        let targetPosition = 0;
                        if (targetElement && targetId !== '#top') {
                            const headerOffset = header ? header.offsetHeight : 70;
                            const isFooterLink = targetId === '#footer-contact';
                            const elementPosition = targetElement.getBoundingClientRect().top;
                            targetPosition = elementPosition + window.pageYOffset - (isFooterLink ? 0 : headerOffset);
                        } else if (!targetElement || targetId === '#top') {
                            targetPosition = 0;
                        }
                        window.scrollTo({ top: targetPosition, behavior: "smooth" });
                        if (mobileMenu && !mobileMenu.classList.contains('hidden') && link.closest('#mobile-menu')) {
                            mobileMenu.classList.add('hidden');
                            menuButton.setAttribute('aria-expanded', 'false');
                        }
                    });
                });
            },

            setCopyrightYear() {
                const currentYearEl = document.getElementById('current-year');
                if (currentYearEl) { currentYearEl.textContent = new Date().getFullYear(); }
            },

            initPostViewCount(postId, postElement) {
                const viewCountElement = postElement.querySelector(`#view-count-${postId}`);
                if (!viewCountElement) { return; }
                if (!this.state.postViewData[postId]) {
                    const initialViewCount = Math.floor(Math.random() * 451) + 50;
                    this.state.postViewData[postId] = { currentViewCount: initialViewCount, intervalId: null };
                    viewCountElement.textContent = initialViewCount;
                } else {
                    viewCountElement.textContent = this.state.postViewData[postId].currentViewCount;
                }
            },

            startPostViewIntervalIfNeeded(postId) {
                if (!this.state.postViewData[postId]) { return; }
                if (this.state.postViewData[postId].intervalId === null) {
                    const intervalId = setInterval(() => {
                        if (!this.state.postViewData[postId]) { clearInterval(intervalId); return; }
                        this.state.postViewData[postId].currentViewCount += Math.floor(Math.random() * 100) + 1;
                        const currentViewEl = document.getElementById(`view-count-${postId}`);
                        if (currentViewEl && document.body.contains(currentViewEl)) {
                            currentViewEl.textContent = this.state.postViewData[postId].currentViewCount;
                        }
                    }, 30000);
                    this.state.postViewData[postId].intervalId = intervalId;
                }
            },

            clearPostViewInterval(postId) {
                if (this.state.postViewData[postId] && this.state.postViewData[postId].intervalId !== null) {
                    clearInterval(this.state.postViewData[postId].intervalId);
                    this.state.postViewData[postId].intervalId = null;
                }
            },

            initializeHeroAnimation() {
                const heroHeadlineElement = document.getElementById('hero-headline');
                const heroSubheadlineElement = document.getElementById('hero-subheadline');
                const animationInClasses = ['hero-text-animate-fade-in', 'hero-text-animate-slide-up-in', 'hero-text-animate-slide-down-in', 'hero-text-animate-zoom-in'];
                let currentSubheadlineIndex = 0;
                let previousInClass = '';
                let nextChangeTimeout;
                const self = this;

                if (heroSubheadlineElement) {
                    const initialStaticSubheadlineText = heroSubheadlineElement.textContent.trim();
                    if (initialStaticSubheadlineText) {
                        heroSubheadlineElement.innerHTML = self.splitTextIntoTwoLines(initialStaticSubheadlineText);
                    }

                    const scheduleNextChange = () => {
                        const randomInterval = (Math.random() * (self.config.ANIMATION_INTERVAL_HERO_MAX_MS - self.config.ANIMATION_INTERVAL_HERO_MIN_MS)) + self.config.ANIMATION_INTERVAL_HERO_MIN_MS;
                        clearTimeout(nextChangeTimeout);
                        if (!document.body.classList.contains('content-hidden')) {
                            nextChangeTimeout = setTimeout(changeSubheadline, randomInterval);
                        }
                    };

                    const changeSubheadline = () => {
                        if (!heroSubheadlineElement || document.body.classList.contains('content-hidden')) { clearTimeout(nextChangeTimeout); return; }
                        heroSubheadlineElement.classList.add('hero-text-animate-out');
                        if (previousInClass) { heroSubheadlineElement.classList.remove(previousInClass); }

                        setTimeout(() => {
                            if (!heroSubheadlineElement) return;
                            currentSubheadlineIndex = (currentSubheadlineIndex + 1) % self.state.heroSubheadlinesList.length;
                            const nextSubheadlineText = self.state.heroSubheadlinesList[currentSubheadlineIndex];
                            heroSubheadlineElement.innerHTML = self.splitTextIntoTwoLines(nextSubheadlineText);

                            const randomAnimationIndex = Math.floor(Math.random() * animationInClasses.length);
                            const nextInClass = animationInClasses[randomAnimationIndex];
                            heroSubheadlineElement.classList.remove('hero-text-animate-out');
                            heroSubheadlineElement.classList.add(nextInClass);
                            previousInClass = nextInClass;
                            scheduleNextChange();
                        }, 500);
                    };

                    heroSubheadlineElement.style.opacity = '1';
                    const initialAnimationClass = 'hero-text-animate-fade-in';
                    heroSubheadlineElement.classList.add(initialAnimationClass);
                    previousInClass = initialAnimationClass;

                    scheduleNextChange();
                }
            },

            initializeIntroParagraphSplitting() {
                const visionIntroEl = document.getElementById('vision-intro-text');
                const involvedIntroEl = document.getElementById('involved-intro-text');
                if (visionIntroEl) {
                    const originalText = visionIntroEl.textContent.trim();
                    visionIntroEl.innerHTML = this.splitTextIntoTwoLines(originalText);
                }
                if (involvedIntroEl) {
                     const originalText = involvedIntroEl.textContent.trim().replace(/\s*<br\s*\/?>\s*/gi, ' ');
                     involvedIntroEl.innerHTML = this.splitTextIntoTwoLines(originalText);
                }
            },

            async generateSinglePost(isInitialCall = false) {
                const postsContainer = document.getElementById('community-posts-container');
                if (!postsContainer) { return; }
                if (isInitialCall) {
                    if (this.state.postGenerationTriggered && !document.getElementById('posts-loading-message')) return;
                    if (!this.state.postGenerationTriggered) this.state.postGenerationTriggered = true;
                }
                const existingGenerateMoreButton = document.getElementById('generate-more-posts-btn');
                if (existingGenerateMoreButton) existingGenerateMoreButton.remove();
                const initialHtmlLoadingMessage = document.getElementById('posts-loading-message');
                const availableSubheadlines = this.state.heroSubheadlinesList.filter((_, index) => !this.state.usedSubheadlineIndexes.includes(index));
                if (availableSubheadlines.length === 0) {
                    if (initialHtmlLoadingMessage) initialHtmlLoadingMessage.remove();
                    if (this.state.usedSubheadlineIndexes.length > 0) {
                        if (!postsContainer.querySelector('.all-generated-message')) {
                            const allGeneratedMessage = document.createElement('p');
                            allGeneratedMessage.className = 'text-center text-gray-400 italic mt-4 all-generated-message';
                            allGeneratedMessage.textContent = 'All available community updates have been generated.';
                            postsContainer.appendChild(allGeneratedMessage);
                        }
                    } else {
                         if (postsContainer.innerHTML.trim() === '' || (initialHtmlLoadingMessage && postsContainer.contains(initialHtmlLoadingMessage) && postsContainer.childElementCount === 1) ) {
                             postsContainer.innerHTML = `<p class="text-center text-gray-400 italic">No themes available to generate community updates.</p>`;
                         }
                    }
                    return;
                }
                if (!isInitialCall && initialHtmlLoadingMessage) initialHtmlLoadingMessage.remove();
                const randomIndexInAvailable = Math.floor(Math.random() * availableSubheadlines.length);
                const selectedSubheadlineText = availableSubheadlines[randomIndexInAvailable];
                const originalIndexInHeroList = this.state.heroSubheadlinesList.indexOf(selectedSubheadlineText);
                this.state.usedSubheadlineIndexes.push(originalIndexInHeroList);
                const postId = `community-post-${originalIndexInHeroList}`;
                let postContentText = `Error generating post content for "${selectedSubheadlineText.substring(0,30)}...". Please try again.`;

                let tempButtonLoadingMessage = null;
                if (!isInitialCall) {
                    tempButtonLoadingMessage = document.createElement('p');
                    tempButtonLoadingMessage.id = `loading-post-${originalIndexInHeroList}`;
                    tempButtonLoadingMessage.className = 'text-center text-gray-400 italic my-4';
                    tempButtonLoadingMessage.textContent = `✨ Generating new post based on: "${selectedSubheadlineText.substring(0, 40)}..."`;
                    postsContainer.appendChild(tempButtonLoadingMessage);
                } else if (initialHtmlLoadingMessage) {
                    initialHtmlLoadingMessage.textContent = `✨ Generating initial community update based on: "${selectedSubheadlineText.substring(0,40)}..."`;
                }

                let fetchSuccess = false;
                try {
                    const serverResponse = await this.fetchFromServer('/api/generate-post-content', { theme: selectedSubheadlineText });
                    if (serverResponse && serverResponse.postText) {
                        postContentText = serverResponse.postText; // Server now sends cleaned text
                        fetchSuccess = true;
                    }
                } catch (error) { /* Error already logged by fetchFromServer */ }

                const paragraphs = postContentText.split(/\n/).map(p => p.trim()).filter(p => p.length > 0);
                const postContentHTML = paragraphs.length > 0 ? paragraphs.map(p => `<p>${p}</p>`).join('') : `<p>${postContentText}</p>`;

                if (isInitialCall && initialHtmlLoadingMessage) initialHtmlLoadingMessage.remove();
                if (tempButtonLoadingMessage) tempButtonLoadingMessage.remove();

                if (isInitialCall && !fetchSuccess && postsContainer.innerHTML.trim() === '') {
                    const errorMsgElement = document.createElement('p');
                    errorMsgElement.className = 'text-center text-red-500 italic my-4 fetch-error-message';
                    errorMsgElement.textContent = 'Failed to generate the initial community update. Please try again later.';
                    postsContainer.appendChild(errorMsgElement);
                } else {
                    const postElement = document.createElement('article');
                    postElement.className = 'community-post bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-xl mb-10 transition-all duration-300 hover:shadow-cyan-500/20 hover:border-gray-600';
                    postElement.setAttribute('data-post-id', postId);
                    postElement.setAttribute('data-theme', selectedSubheadlineText);
                    postElement.innerHTML = `
                        <div class="flex items-start space-x-4">
                            <img class="h-10 w-10 sm:h-12 sm:w-12 rounded-full object-cover flex items-center justify-center border-2 border-gray-700" src="https://ui-avatars.com/api/?name=S&background=06b6d4&color=ffffff&size=48&font-size=0.5&bold=true" alt="Stimuli Avatar">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-semibold text-gray-100">Stimuli Community</span>
                                    <button id="tts-button-${postId}" class="tts-button" data-post-id="${postId}" aria-label="Read post aloud">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-cyan-400 mb-3">${selectedSubheadlineText}</p>
                                <div id="post-content-${postId}" class="post-content-wrapper text-base text-gray-300" style="line-height: 1.6;"> ${postContentHTML} </div>
                                <div class="mt-3 flex items-center">
                                    <button id="show-more-${postId}" class="show-more-less-btn text-cyan-400 hover:text-cyan-300 font-medium text-sm hidden" aria-expanded="false" aria-controls="post-content-${postId}">Show more</button>
                                    <button id="show-less-${postId}" class="show-more-less-btn text-cyan-400 hover:text-cyan-300 font-medium text-sm hidden" aria-expanded="true" aria-controls="post-content-${postId}">Show less</button>
                                    <button id="elaborate-post-${postId}" class="gemini-button elaborate-btn" data-post-id="${postId}">Elaborate with AI ✨</button>
                                </div>
                                <div id="elaboration-content-${postId}" class="elaboration-content hidden">
                                     </div>
                                <div id="post-actions-${postId}" class="post-actions hidden flex justify-start space-x-6 text-gray-400">
                                    <button class="comment-btn flex items-center space-x-1.5 text-gray-400 hover:text-cyan-400 transition-colors" data-post-id="${postId}" aria-label="Comments" aria-expanded="false" aria-controls="comments-container-${postId}">
                                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                        <span id="comment-count-${postId}" class="comment-count text-xs text-gray-400 invisible" aria-live="polite" aria-busy="false">0 / 0</span>
                                    </button>
                                    <span class="flex items-center space-x-1.5 text-gray-400 cursor-default">
                                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                        <span id="view-count-${postId}" class="text-xs text-gray-400">0</span>
                                    </span>
                                </div> <div id="comments-container-${postId}" class="comments-container hidden"></div>
                            </div>
                        </div>
                    </article>`;
                    postsContainer.appendChild(postElement);
                    this.initPostViewCount(postId, postElement);
                    this.initializeSinglePost(postElement);
                }
                const stillAvailableAfterPost = this.state.heroSubheadlinesList.filter((_, index) => !this.state.usedSubheadlineIndexes.includes(index));
                if (stillAvailableAfterPost.length > 0) {
                    this.addGenerateMoreButton();
                } else {
                    if (!postsContainer.querySelector('.all-generated-message') && !postsContainer.querySelector('.fetch-error-message')) {
                        const allGeneratedMsg = document.createElement('p');
                        allGeneratedMsg.className = 'text-center text-gray-400 italic mt-4 all-generated-message';
                        allGeneratedMsg.textContent = 'All available community updates have been generated.';
                        postsContainer.appendChild(allGeneratedMsg);
                    }
                }
            },

            addGenerateMoreButton() {
                const communitySectionContainer = document.getElementById('community')?.querySelector('.container');
                if (!communitySectionContainer) { return; }
                const existingButton = document.getElementById('generate-more-posts-btn');
                if (existingButton) existingButton.remove();
                const button = document.createElement('button');
                button.id = 'generate-more-posts-btn';
                button.textContent = 'Generate another post... ✨';
                button.className = 'mt-8 mb-4 mx-auto block bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-opacity-50';
                button.addEventListener('click', async () => {
                    button.disabled = true;
                    button.textContent = '✨ Generating...';
                    const postsContainer = document.getElementById('community-posts-container');
                    const allGenMsg = postsContainer?.querySelector('.all-generated-message');
                    if (allGenMsg) allGenMsg.remove();
                     const fetchErrorMsg = postsContainer?.querySelector('.fetch-error-message');
                    if (fetchErrorMsg) fetchErrorMsg.remove();
                    await this.generateSinglePost(false);
                });
                communitySectionContainer.appendChild(button);
            },

            initializeSinglePost(postElement) {
                const postId = postElement.getAttribute('data-post-id');
                const contentWrapper = postElement.querySelector(`#post-content-${postId}`);
                const showMoreBtn = postElement.querySelector(`#show-more-${postId}`);
                const showLessBtn = postElement.querySelector(`#show-less-${postId}`);
                const postActionsDiv = postElement.querySelector(`#post-actions-${postId}`);
                const commentIconBtn = postElement.querySelector(`.comment-btn[data-post-id="${postId}"]`);
                const commentsContainer = postElement.querySelector(`#comments-container-${postId}`);
                const commentCountElement = postElement.querySelector(`#comment-count-${postId}`);
                const elaborateBtn = postElement.querySelector(`#elaborate-post-${postId}`);
                const elaborationContentDiv = postElement.querySelector(`#elaboration-content-${postId}`);
                const ttsButton = postElement.querySelector(`#tts-button-${postId}`);

                if (!contentWrapper || !showMoreBtn || !showLessBtn || !postActionsDiv || !commentIconBtn || !commentsContainer || !commentCountElement || !elaborateBtn || !elaborationContentDiv || !ttsButton) {
                    return;
                }

                const computedStyle = window.getComputedStyle(contentWrapper);
                const lineHeight = parseFloat(computedStyle.lineHeight);
                const fontSize = parseFloat(computedStyle.fontSize);
                const effectiveLineHeight = isNaN(lineHeight) ? fontSize * 1.6 : lineHeight;
                const collapsedHeightThreshold = effectiveLineHeight * this.config.COLLAPSED_LINES;
                const self = this;
                const checkOverflow = () => {
                    if (!contentWrapper || !showMoreBtn || !showLessBtn || !postActionsDiv || !commentCountElement) return;
                    const isManuallyExpanded = !showLessBtn.classList.contains('hidden');
                    contentWrapper.style.display = 'none'; contentWrapper.offsetHeight; contentWrapper.style.display = '';
                    const scrollHeight = contentWrapper.scrollHeight;
                    const isOverflowing = scrollHeight > (collapsedHeightThreshold + 10);
                    showMoreBtn.classList.add('hidden');
                    showLessBtn.classList.add('hidden');
                    if (isOverflowing) {
                        if (isManuallyExpanded) {
                            contentWrapper.classList.remove('post-content-collapsed');
                            contentWrapper.classList.add('post-content-expanded');
                            contentWrapper.style.maxHeight = `${scrollHeight}px`;
                            showLessBtn.classList.remove('hidden');
                            showLessBtn.setAttribute('aria-expanded', 'true');
                            postActionsDiv.classList.remove('hidden');
                            self.startPostViewIntervalIfNeeded(postId);
                            if(self.state.activeSimulations[postId] && self.state.postCommentCounts[postId] !== undefined){
                                const sim = self.state.activeSimulations[postId];
                                commentCountElement.textContent = `${sim.displayedCommentCount} / ${sim.totalFetchedCount}`;
                                if (sim.totalFetchedCount > 0) commentCountElement.classList.remove('invisible');
                                else commentCountElement.classList.add('invisible');
                                commentCountElement.classList.remove('loading');
                                commentCountElement.setAttribute('aria-busy', 'false');
                            } else if (!self.state.loadingCommentCount[postId]) {
                                commentCountElement.textContent = '0 / 0';
                                commentCountElement.classList.add('invisible');
                            }
                        } else {
                            contentWrapper.classList.remove('post-content-expanded');
                            contentWrapper.classList.add('post-content-collapsed');
                            contentWrapper.style.maxHeight = `${Math.round(collapsedHeightThreshold)}px`;
                            showMoreBtn.classList.remove('hidden');
                            showMoreBtn.setAttribute('aria-expanded', 'false');
                            postActionsDiv.classList.add('hidden');
                            self.clearPostViewInterval(postId);
                            if (!commentCountElement.classList.contains('loading')) {
                                commentCountElement.classList.add('invisible');
                            }
                            if (commentsContainer && !commentsContainer.classList.contains('hidden')) {
                                commentsContainer.classList.add('hidden');
                                commentsContainer.classList.remove('comments-active');
                                if (commentIconBtn) commentIconBtn.setAttribute('aria-expanded', 'false');
                            }
                        }
                    } else {
                        contentWrapper.classList.remove('post-content-collapsed');
                        contentWrapper.classList.add('post-content-expanded');
                        contentWrapper.style.maxHeight = 'none';
                        postActionsDiv.classList.remove('hidden');
                        self.startPostViewIntervalIfNeeded(postId);
                        showMoreBtn.setAttribute('aria-expanded', 'true');
                        if (isManuallyExpanded && self.state.activeSimulations[postId] && self.state.postCommentCounts[postId] !== undefined) {
                             const sim = self.state.activeSimulations[postId];
                             commentCountElement.textContent = `${sim.displayedCommentCount} / ${sim.totalFetchedCount}`;
                             if (sim.totalFetchedCount > 0) commentCountElement.classList.remove('invisible', 'loading');
                             else commentCountElement.classList.add('invisible');
                             commentCountElement.setAttribute('aria-busy', 'false');
                        } else if (!isManuallyExpanded) {
                             if (!self.state.loadingCommentCount[postId] && !self.state.activeSimulations[postId]) {
                                 postActionsDiv.classList.remove('hidden');
                                 self.startPostViewIntervalIfNeeded(postId);
                                 commentCountElement.textContent = '0 / 0';
                                 commentCountElement.classList.add('invisible');
                             }
                        }
                    }
                };
                let resizeTimeout;
                window.addEventListener('resize', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(checkOverflow, 150); });
                requestAnimationFrame(() => { setTimeout(checkOverflow, 50); });

                showMoreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    contentWrapper.classList.remove('post-content-collapsed');
                    contentWrapper.classList.add('post-content-expanded');
                    contentWrapper.style.maxHeight = `${contentWrapper.scrollHeight}px`;
                    showMoreBtn.classList.add('hidden');
                    showLessBtn.classList.remove('hidden');
                    showMoreBtn.setAttribute('aria-expanded', 'true');
                    showLessBtn.setAttribute('aria-expanded', 'true');
                    postActionsDiv.classList.remove('hidden');
                    self.startPostViewIntervalIfNeeded(postId);
                    if (!self.state.activeSimulations[postId] || self.state.activeSimulations[postId].totalFetchedCount === 0) {
                        self.loadAndPrepareComments(postId);
                    }
                });
                showLessBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    self.resetPostState(postId, true);
                    contentWrapper.style.maxHeight = `${Math.round(collapsedHeightThreshold)}px`;
                    setTimeout(() => { contentWrapper.classList.add('post-content-collapsed'); }, 10);
                    contentWrapper.classList.remove('post-content-expanded');
                    showLessBtn.classList.add('hidden');
                    showMoreBtn.classList.remove('hidden');
                    showMoreBtn.setAttribute('aria-expanded', 'false');
                    showLessBtn.setAttribute('aria-expanded', 'false');
                    postActionsDiv.classList.add('hidden');
                    if(commentIconBtn) commentIconBtn.setAttribute('aria-expanded', 'false');
                });
                commentIconBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!postActionsDiv.classList.contains('hidden')) {
                        const wasHidden = commentsContainer.classList.contains('hidden');
                        commentsContainer.classList.toggle('hidden');
                        commentIconBtn.setAttribute('aria-expanded', String(!wasHidden));
                        if (!wasHidden) {
                            commentsContainer.classList.remove('comments-active');
                        } else {
                            const totalCount = self.state.postCommentCounts[postId];
                            if (totalCount !== undefined && totalCount > 0) {
                                commentsContainer.classList.add('comments-active');
                                commentsContainer.scrollTo({ top: 0, behavior: 'smooth' });
                            } else {
                                commentsContainer.classList.remove('comments-active');
                                if (!commentsContainer.querySelector('.comment-thread') && !commentsContainer.querySelector('p')) {
                                 if (totalCount === 0) {
                                     commentsContainer.innerHTML = `<p class="text-sm text-gray-400 italic p-2">No comments generated for this post.</p>`;
                                 } else {
                                     commentsContainer.innerHTML = `<p class="text-sm text-gray-400 italic p-2">Click 'Show more' on the post first to load comments.</p>`;
                                 }
                                }
                            }
                        }
                    }
                });

                elaborateBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const elaborationTtsButtonId = `tts-elaboration-button-${postId}`;

                    if (!elaborationContentDiv.classList.contains('hidden')) {
                        if (self.state.speechSynthesis.speaking && self.state.speakingElementId === elaborationTtsButtonId) {
                            self.state.speechSynthesis.cancel();
                        }
                        elaborationContentDiv.innerHTML = '';
                        elaborationContentDiv.classList.add('hidden');
                        elaborateBtn.textContent = 'Elaborate with AI ✨';
                        return;
                    }

                    elaborateBtn.disabled = true;
                    elaborateBtn.textContent = 'Thinking...';
                    elaborationContentDiv.innerHTML = '<p class="text-center text-gray-400 italic">✨ AI is generating insights...</p>';
                    elaborationContentDiv.classList.remove('hidden');

                    const originalTheme = postElement.getAttribute('data-theme');
                    const currentPostContentForContext = contentWrapper.textContent.substring(0, 200);

                    let newContentText = "Failed to get insights for this post. Please try again.";
                    try {
                        const serverResponse = await self.fetchFromServer('/api/elaborate-post', {
                            theme: originalTheme,
                            originalPostContext: currentPostContentForContext
                        });
                        if (serverResponse && serverResponse.elaborationText) {
                            newContentText = serverResponse.elaborationText; // Server sends cleaned text
                        }
                    } catch (error) { /* Error already logged */ }

                    const newParagraphs = newContentText.split(/\n/).map(p => p.trim()).filter(p => p.length > 0);

                    const elaborationHtml = `
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-cyan-300">AI Insights on "${originalTheme}"</h4>
                            <button id="${elaborationTtsButtonId}" class="tts-button" data-content-target="elaboration-text-${postId}" aria-label="Read elaboration aloud">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                        <div id="elaboration-text-${postId}">
                            ${newParagraphs.length > 0 ? newParagraphs.map(p => `<p>${p}</p>`).join('') : `<p>${newContentText}</p>`}
                        </div>`;
                    elaborationContentDiv.innerHTML = elaborationHtml;

                    const newTtsButton = elaborationContentDiv.querySelector(`#${elaborationTtsButtonId}`);
                    const newElaborationTextDiv = elaborationContentDiv.querySelector(`#elaboration-text-${postId}`);
                    if (newTtsButton && newElaborationTextDiv) {
                         newTtsButton.addEventListener('click', (ev) => {
                             ev.stopPropagation();
                             self.toggleSpeech(postId, newElaborationTextDiv, newTtsButton, elaborationTtsButtonId);
                         });
                    }

                    elaborateBtn.textContent = 'Hide Elaboration';
                    elaborateBtn.disabled = false;
                });

                ttsButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    self.toggleSpeech(postId, contentWrapper, ttsButton, `tts-button-${postId}`);
                });
            },

            toggleSpeech(postId, contentElement, buttonElement, buttonId) {
                if (!this.state.speechSynthesis) {
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    buttonElement.setAttribute('aria-label', 'Speech not supported');
                    return;
                }

                const isCurrentlySpeakingThis = this.state.speechSynthesis.speaking && this.state.speakingElementId === buttonId;

                if (this.state.speechSynthesis.speaking || this.state.speechSynthesis.pending) {
                    if (this.state.currentUtterance) {
                        this.state.currentUtterance.onend = null;
                        this.state.currentUtterance.onerror = null;
                    }
                    this.state.speechSynthesis.cancel();
                }

                if (this.state.speakingElementId && this.state.speakingElementId !== buttonId) {
                    const oldButton = document.getElementById(this.state.speakingElementId);
                    if (oldButton) {
                        oldButton.classList.remove('speaking');
                        oldButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                        oldButton.setAttribute('aria-label', oldButton.id.includes('elaboration') ? 'Read elaboration aloud' : 'Read post aloud');
                    }
                }

                this.state.currentUtterance = null;
                this.state.speakingElementId = null;

                if (isCurrentlySpeakingThis) {
                    buttonElement.classList.remove('speaking');
                    buttonElement.innerHTML = '<i class="fas fa-volume-up"></i>';
                    buttonElement.setAttribute('aria-label', buttonId.includes('elaboration') ? 'Read elaboration aloud' : 'Read post aloud');
                } else {
                    const textToSpeak = contentElement.textContent || contentElement.innerText || "";
                    if (textToSpeak.trim() === "") {
                        buttonElement.classList.remove('speaking');
                        buttonElement.innerHTML = '<i class="fas fa-volume-up"></i>';
                        buttonElement.setAttribute('aria-label', buttonId.includes('elaboration') ? 'Read elaboration aloud' : 'Read post aloud');
                        return;
                    }

                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    this.state.currentUtterance = utterance;
                    this.state.speakingElementId = buttonId;

                    utterance.onend = () => {
                        if (this.state.currentUtterance === utterance && this.state.speakingElementId === buttonId) {
                            this.state.speakingElementId = null;
                            this.state.currentUtterance = null;
                            buttonElement.classList.remove('speaking');
                            buttonElement.innerHTML = '<i class="fas fa-volume-up"></i>';
                            buttonElement.setAttribute('aria-label', buttonId.includes('elaboration') ? 'Read elaboration aloud' : 'Read post aloud');
                        }
                    };
                    utterance.onerror = (event) => {
                        if (this.state.currentUtterance === utterance && this.state.speakingElementId === buttonId) {
                            this.state.speakingElementId = null;
                            this.state.currentUtterance = null;
                            buttonElement.classList.remove('speaking');
                            buttonElement.innerHTML = '<i class="fas fa-volume-up"></i>';
                            buttonElement.setAttribute('aria-label', buttonId.includes('elaboration') ? 'Read elaboration aloud' : 'Read post aloud');
                        }
                    };

                    this.state.speechSynthesis.speak(utterance);
                    buttonElement.classList.add('speaking');
                    buttonElement.innerHTML = '<i class="fas fa-stop-circle"></i>';
                    buttonElement.setAttribute('aria-label', 'Stop reading');
                }
            },

            initializeCarousel() {
                const carouselDisplayContainer = document.querySelector('#projects .carousel-container');
                const dotsContainer = document.querySelector('#projects .carousel-dots');

                if (!carouselDisplayContainer || !dotsContainer ) {
                    const projectsSection = document.getElementById('projects');
                    if (projectsSection) {
                         const containerDiv = projectsSection.querySelector('.container');
                         if(containerDiv) containerDiv.innerHTML = '<p class="text-center text-gray-400 italic">Project showcase is currently unavailable.</p>';
                    }
                    return;
                }

                carouselDisplayContainer.innerHTML = '';
                dotsContainer.innerHTML = '';

                if (!this.config.PROJECT_IMAGES || this.config.PROJECT_IMAGES.length === 0) {
                    carouselDisplayContainer.innerHTML = '<p class="text-center text-gray-400 italic p-4">No projects to display at the moment.</p>';
                    dotsContainer.style.display = 'none';
                    return;
                }

                this.config.PROJECT_IMAGES.forEach((image, index) => {
                    const slide = document.createElement('div');
                    slide.classList.add('carousel-slide');

                    const img = document.createElement('img');
                    img.src = image.src;
                    img.alt = image.alt;
                    img.loading = 'lazy';
                    img.onerror = function() {
                        this.src='https://placehold.co/800x500/1f2937/e0e0e0?text=Image+Not+Found';
                        this.alt='Image not found for: ' + image.alt;
                    };
                    slide.appendChild(img);
                    carouselDisplayContainer.appendChild(slide);

                    const dot = document.createElement('span');
                    dot.classList.add('carousel-dot');
                    dot.setAttribute('data-slide-to', index);
                    dot.addEventListener('click', () => this.showCarouselSlide(index));
                    dotsContainer.appendChild(dot);
                });
                this.showCarouselSlide(this.state.currentCarouselSlide);
            },

            nextCarouselSlide() {
                const slides = document.querySelectorAll('#projects .carousel-slide');
                if (!slides || slides.length <= 1) {
                    if(this.state.carouselIntervalId) clearInterval(this.state.carouselIntervalId);
                    this.state.carouselIntervalId = null;
                    return;
                }
                let nextIndex = this.state.currentCarouselSlide + 1;
                if (nextIndex >= slides.length) {
                    nextIndex = 0;
                }
                this.showCarouselSlide(nextIndex);
            },

            showCarouselSlide(index) {
                const slides = document.querySelectorAll('#projects .carousel-slide');
                const dots = document.querySelectorAll('#projects .carousel-dot');

                if (slides.length === 0) return;

                if (this.state.carouselIntervalId) {
                    clearInterval(this.state.carouselIntervalId);
                    this.state.carouselIntervalId = null;
                }

                if (index >= slides.length) this.state.currentCarouselSlide = 0;
                else if (index < 0) this.state.currentCarouselSlide = slides.length - 1;
                else this.state.currentCarouselSlide = index;

                slides.forEach((slide, i) => {
                    slide.classList.toggle('active', i === this.state.currentCarouselSlide);
                });
                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === this.state.currentCarouselSlide);
                });

                if (slides.length > 1) {
                    const nextSlideIndex = (this.state.currentCarouselSlide + 1) % slides.length;
                    const nextSlide = slides[nextSlideIndex];
                    const nextImageElement = nextSlide.querySelector('img');
                    if (nextImageElement && nextImageElement.src) {
                        const preloader = new Image();
                        preloader.src = nextImageElement.src;
                    }
                }

                if (slides.length > 1) {
                    this.state.carouselIntervalId = setInterval(() => this.nextCarouselSlide(), 10000);
                }
            },

            init() {
                const contentShownEvent = new Event('contentShown');
                const disclaimerModal = document.getElementById('disclaimer-modal');
                const disclaimerTitle = document.getElementById('disclaimer-title');
                const disclaimerText = document.getElementById('disclaimer-text');
                const yesBtn = document.getElementById('disclaimer-yes-btn');
                const noBtn = document.getElementById('disclaimer-no-btn');
                const showContent = () => {
                    disclaimerModal?.classList.add('hidden');
                    document.body.classList.remove('content-hidden');
                    document.body.dispatchEvent(contentShownEvent);
                }
                if (disclaimerModal && yesBtn && noBtn && disclaimerTitle && disclaimerText) {
                    yesBtn.addEventListener('click', showContent);
                    noBtn.addEventListener('click', () => {
                        disclaimerTitle.textContent = "Action Cancelled";
                        disclaimerText.innerHTML = "You have chosen not to proceed. <br><br>You can now close this window or tab.";
                        yesBtn.disabled = true;
                        noBtn.disabled = true;
                        yesBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        noBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                } else {
                    showContent();
                }
                document.body.addEventListener('contentShown', () => {
                    this.initializeHeroAnimation();
                    this.initializeIntroParagraphSplitting();
                    this.initializeMenuAndScroll();
                    this.setCopyrightYear();
                    this.initializeCarousel();
                    const postsLoadingMessage = document.getElementById('posts-loading-message');
                    if (!this.state.postGenerationTriggered) {
                        if (this.state.heroSubheadlinesList && this.state.heroSubheadlinesList.length > 0) {
                            setTimeout(() => { this.generateSinglePost(true); }, 500);
                        } else {
                            if (postsLoadingMessage) { postsLoadingMessage.textContent = 'No themes available for community updates at the moment.'; }
                             setTimeout(() => { this.generateSinglePost(true); }, 500);
                        }
                    }
                }, { once: true });
            }
        };
        stimuliApp.init();
    </script>

    </body>
</html>
